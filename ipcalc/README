Some of this code is taken from the PHP Subnet Calculator, available here under the GPL:

http://share-foo.com/SubnetCalc.php